#!/bin/bash

#####OSCAM_Autoupdate

_url=https://friendsforroland.github.io/oscam

#compare oscam version
wget -O /tmp/version.txt ${_url}/version.txt > /dev/null 2>&1
file="/tmp/version.txt"
search="version="
X=8 
content=$(grep "$search" "$file")

if [ -n "$content" ]; then
  Version_new=$(echo "$content" | cut -c $((X + 1))-)
fi

_myoscambin=$(ps xuww | grep -i oscam | grep -vE 'grep|tail' | awk '{print $11}'|uniq)
_oscambin=$(echo "$_myoscambin" | cut -c $((9 + 1))-)

$_myoscambin -V > /tmp/version2.txt
file2="/tmp/version2.txt"
search2="Version:     "
X=24
content2=$(grep "$search2" "$file2")

if [ -n "$content2" ]; then
  Version_old=$(echo "$content2" | cut -c $((X + 1))-)
  Version_old=$(echo "$Version_old" | sed 's/.........$//')
fi
  if [[ "$Version_new" != "$Version_old" ]]; then
    # find arch und backup old oscam 
  cp ${_myoscambin} ${_myoscambin}_bak
if [ -n "$(uname -m | grep armv7l)" ]; then
    _arch=open_arm
 elif [ -n "$(uname -m | grep aarch64)" ]; then
    _arch=aarch64
 elif [ -n "$(uname -m | grep mips)" ]; then
    _arch=mipsel
 else
      echo -e "\e[31m Sorry, your device does not have the proper Emu \e[0m"
      exit 1
fi

    # kill_oscam
  for pid in `ps xuww | grep oscam | grep "$_myoscambin" | grep -v grep | awk '{print $2}'`; do
    kill -9 $pid
  done

   # replace oscam  
  if [ -e /etc/apt/sources.list.d  ]; then
     wget -O $_myoscambin ${_url}/oscams/oscam-dream_${_arch}-$Version_new > /dev/null 2>&1
     chmod +x $_myoscambin
   else
    wget -O $_myoscambin ${_url}/oscams/oscam-${_arch}-$Version_new > /dev/null 2>&1
    chmod +x $_myoscambin
  fi
  /etc/init.d/softcam.$_oscambin restart > /dev/null 2>&1

 else
    echo ""
 fi
# clean tmp
rm /tmp/version* > /dev/null 2>&1
